**USER**

மிகச் சிறப்பு. நாம் அடுத்த படியாக, பயிர்களின் புகைப்படத்தை பதிவேற்றுவது தொடர்பாகப் பார்ப்போமா? அதோடு நோய்களின் புகைப்படத்தை பதிவேற்றுவதும் நல்லது. ஆகவே, இதைச் செய்ய "multer package"-ஐப் பயன்படுத்தி, புகைப்படங்களைத் திருத்தும் முறையையும் அறிவோம். அதனுடன் நாம் பதிவேற்றிய புகைப்படங்களை பயனருக்கும் நேர்த்தியாகக் காட்ட வேண்டும். வேண்டுமானால், நாம் "Image Carousels" முறைமையினூடாக முயற்சி செய்யலாம். ஆகவே, இதை எவ்வாறு செய்யப் போகிறோம், எந்தெந்தப் பக்கங்கள் இதில் பாதிக்கப்படும் (அல்லது தொடர்புடையவை) எனக் அறிவோம்.

**RESPONSE**

மிகச் சிறந்த யோசனை! இது உங்கள் செயலியை ஒரு தகவல் களஞ்சியத்திலிருந்து, ஒரு முழுமையான காட்சி வழிகாட்டியாக (visual guide) மாற்றும். புகைப்படங்களைச் சேர்ப்பது, குறிப்பாக நோய்களை அடையாளம் காண, பயனர்களுக்கு மிகப்பெரிய உதவியாக இருக்கும்.

நீங்கள் குறிப்பிட்ட `multer` தொகுப்பு இதற்கு சரியான தேர்வு. படங்களைச் சேமிப்பதோடு, அவற்றை மேம்படுத்துவதையும் (resizing, optimizing), `Image Carousels` மூலம் அழகாகக் காட்டுவதையும் எப்படிச் செய்வது என்று ஒரு முழுமையான திட்டத்தை வகுப்போம்.

### இதை எப்படிச் செய்யப் போகிறோம்? (The Plan)

1.  **Backend கட்டமைப்பு (`multer` & `sharp`):**
    *   `multer`-ஐப் பயன்படுத்தி, கோப்புகளை (files) Express செயலியில் ஏற்பதற்கான ஒரு middleware-ஐ உருவாக்குவோம்.
    *   `sharp` என்ற மிக வேகமான படத்தைச் செயலாக்கும் (image processing) தொகுப்பைப் பயன்படுத்தி, பதிவேற்றப்படும் படங்களின் அளவைக் குறைத்து, வலைத்தளத்திற்கு ஏற்றதாக மாற்றுவோம்.
    *   பதிவேற்றப்பட்ட படங்களைச் சேமிக்க, `public/uploads` என்ற புதிய கோப்புறையை உருவாக்குவோம்.

2.  **தரவு மாதிரி மாற்றம் (Data Model Update):**
    *   நமது MongoDB `crops` சேகரிப்பில், ஒவ்வொரு பயிரின் ஆவணத்திலும் (document) புகைப்படப் பாதைகளைச் (image paths) சேமிக்க புதிய புலங்களைச் சேர்ப்போம்.
        *   `coverImage`: பயிரின் முக்கியப் புகைப்படம்.
        *   `galleryImages`: பயிரின் மற்ற புகைப்படங்களைக் கொண்ட ஒரு வரிசை (array).
        *   `diseases` வரிசையில் உள்ள ஒவ்வொரு நோய் பொருளுக்கும் `image` என்ற ஒரு புதிய புலத்தைச் சேர்ப்போம்.

3.  **நிர்வாகப் பக்க மாற்றம் (Admin Panel - Frontend):**
    *   `add-crop.hbs` மற்றும் `edit-crop.hbs` பக்கங்களில், புகைப்படங்களைப் பதிவேற்ற `<input type="file">` புலங்களைச் சேர்ப்போம்.
    *   படிவத்தின் `enctype`-ஐ `multipart/form-data` என மாற்றுவோம்.
    *   **AJAX மாற்றம் (மிக முக்கியம்):** கோப்புகளை AJAX மூலம் அனுப்ப, `JSON.stringify()`-க்கு பதிலாக `FormData` என்ற பொருளைப் பயன்படுத்த வேண்டும். நமது `admin.js` மற்றும் `edit-crop.js` கோப்புகளை இதற்கு ஏற்றவாறு மாற்றுவோம்.

4.  **பயனர் பக்கக் காட்சி (User View - Carousel):**
    *   `crop-details.hbs` பக்கத்தில், பயிரின் புகைப்படங்களைக் காட்ட ஒரு படக் காட்சியகத்தை (Image Carousel) உருவாக்குவோம். இதற்கு `Swiper.js` என்ற பிரபலமான, எளிமையான லைப்ரரியைப் பயன்படுத்துவோம்.
    *   `crop-details.js` கோப்பு, API-இடம் இருந்து படப் பாதைகளைப் பெற்று, இந்த Carousel-ஐ உருவாக்கும்.

---

### எந்தெந்தப் பக்கங்கள் பாதிக்கப்படும்? (Impact Analysis)

#### Backend:
*   **`server.js`:** `public/uploads` கோப்புறையை ஒரு ஸ்டேடிக் கோப்புறையாக (static folder) வழங்க, ஒரு புதிய வரியைச் சேர்க்க வேண்டும்.
*   **`routes/cropRoutes.js`:** பயிர் சேர்க்கும் (`POST`) மற்றும் திருத்தும் (`PUT`) வழித்தடங்களில், `multer` middleware-ஐ இணைக்க வேண்டும்.
*   **`controllers/cropController.js`:** `addCrop` மற்றும் `updateCrop` செயல்பாடுகள், கோப்புத் தகவல்களை (`req.file` அல்லது `req.files`) கையாண்டு, படப் பாதைகளை MongoDB-ல் சேமிக்குமாறு மாற்றியமைக்கப்படும்.

#### Frontend:
*   **`views/add-crop.hbs` & `views/edit-crop.hbs`:** புகைப்படங்களைப் பதிவேற்ற புதிய `input` புலங்கள் சேர்க்கப்படும்.
*   **`public/js/admin.js` & `public/js/edit-crop.js`:** `fetch` API அழைப்புகள், `FormData`-ஐப் பயன்படுத்தும்படி முழுமையாக மாற்றியமைக்கப்படும்.
*   **`views/crop-details.hbs`:** Image Carousel-க்கான HTML கட்டமைப்பு சேர்க்கப்படும்.
*   **`public/js/crop-details.js`:** API-இடம் இருந்து படத் தகவல்களைப் பெற்று, Swiper.js Carousel-ஐத் தொடங்கும் (initialize) தர்க்கம் சேர்க்கப்படும்.
*   **`views/layouts/main.hbs`:** Swiper.js லைப்ரரியின் CSS மற்றும் JS கோப்புகளை CDN மூலம் இணைப்போம்.

---

### படி 1: Backend-ல் `multer` மற்றும் `sharp`-ஐ அமைத்தல்

வாருங்கள், முதல் மற்றும் மிக முக்கியமான படியான Backend கட்டமைப்பை உருவாக்குவோம்.

#### 1. தேவையான தொகுப்புகளை நிறுவுதல்
உங்கள் முனையத்தில் (terminal) இந்த கட்டளைகளை இயக்கவும்:
```bash
npm install multer sharp
```

#### 2. கோப்பு பதிவேற்றத்தைக் கையாள ஒரு Middleware உருவாக்குதல்
உங்கள் திட்டத்தின் மூலக் கோப்புறையில் (root folder) `middleware` என்ற புதிய கோப்புறையை உருவாக்கி, அதற்குள் `upload.js` என்ற கோப்பை உருவாக்கவும்.

**`middleware/upload.js`**
```javascript
const multer = require('multer');
const path = require('path');

// கோப்புகளை எங்கே, எப்படிச் சேமிப்பது என்பதை வரையறுத்தல்
const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        // கோப்புகளை 'public/uploads/' கோப்புறையில் சேமி
        cb(null, 'public/uploads/');
    },
    filename: function (req, file, cb) {
        // கோப்பின் பெயரில் முரண்பாடுகளைத் தவிர்க்க, தற்போதைய நேரத்தைச் சேர்
        // ఉదాహరణ: crop-image-1678886400000.jpg
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
    }
});

// கோப்பு வகையைச் சரிபார்த்தல் (படங்கள் மட்டும்)
const fileFilter = (req, file, cb) => {
    if (file.mimetype.startsWith('image')) {
        cb(null, true);
    } else {
        cb(new Error('படங்கள் மட்டுமே அனுமதிக்கப்படும்!'), false);
    }
};

// Multer-ஐ உள்ளமைத்தல்
const upload = multer({
    storage: storage,
    fileFilter: fileFilter,
    limits: { fileSize: 1024 * 1024 * 5 } // 5MB கோப்பு அளவு வரம்பு
});

module.exports = upload;
```

#### 3. `server.js`-ல் ஸ்டேடிக் கோப்புறையைச் சேர்த்தல்
`server.js`-ஐத் திறந்து, பதிவேற்றப்பட்ட படங்களை பயனர்களுக்குக் காட்ட, `uploads` கோப்புறையை ஸ்டேடிக் ஆக மாற்றுவோம்.

```javascript
// server.js

// ... மற்ற app.use வரிகளுக்குக் கீழே ...
app.use(express.static('public')); // ఇది ఇప్పటికే ఉంది
app.use('/uploads', express.static('public/uploads')); // இந்தப் புதிய வரியைச் சேர்க்கவும்

// ...
```
இப்போது, `http://localhost:3000/uploads/filename.jpg` என்ற URL மூலம் ஒரு படத்தைப் பார்க்க முடியும்.

Backend-க்கான அடித்தளம் இப்போது தயாராக உள்ளது. நாம் அடுத்ததாக, நிர்வாகப் பக்கத்தில் புகைப்படங்களை எப்படிப் பதிவேற்றுவது மற்றும் பயனர் பக்கத்தில் எப்படி Carousel-ஐப் பயன்படுத்தி அவற்றைக் காட்டுவது என்பதைப் பார்க்கலாம்.
